
pipeline {
    agent none
    options {
        timestamps()
    }
    stages {
        stage('Build'){
            matrix {
                axes {
                    axis {
                        name 'DISTRO'
                        values 'alpine', 'ubuntu'
                    }
                }
                agent {
                    dockerfile {
                        dir "build/jenkins/${DISTRO}"
                    }
                }
                stages {
                    stage('Bootstrap'){
                        steps {
                            sh 'autoreconf --install'
                            sh 'rm resip/stack/gen/*'
                        }
                    }
                    stage('Configure'){
                        steps {
                            sh "./configure --enable-assert-syslog \
                                            --enable-dtls \
                                            --enable-ipv6 \
                                            --enable-repro-plugins \
                                            --with-apps \
                                            --with-c-ares \
                                            --with-mysql \
                                            --with-netsnmp \
                                            --with-popt \
                                            --with-postgresql \
                                            --with-python \
                                            --with-repro \
                                            --with-return \
                                            --with-ssl \
                                            CXXFLAGS=\"-I${WORKSPACE}/contrib/cajun/include -I/usr/include/mysql\" \
                                            DEPS_PYTHON_CFLAGS=\"`/usr/bin/python3.8-config --cflags`\" \
                                            DEPS_PYTHON_LIBS=\"`/usr/bin/python3.8-config --ldflags`\""
                        }
                    }
                    stage('Build'){
                        steps {
                            sh 'make'
                        }
                    }
                    stage('Test'){
                        steps {
                            sh 'make check'
                        }
                    }
                }
                post {
                    always {
                        recordIssues (
                            tools: [
                                gcc(
                                    id: "${DISTRO}-gcc",
                                    name: "${DISTRO} - GNU C Compiler (gcc)"
                                )
                            ]
                        )
                    }
                    cleanup {
                        cleanWs()
                    }
                }
            }
        }
    }
}